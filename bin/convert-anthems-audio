#!/usr/bin/env babel-node

import fs from 'fs';
import request from 'request';
import path from 'path';
import nomnom from 'nomnom';
import process from 'process';
import { spawn } from 'child_process';
import cheerio from 'cheerio';

const exists = (filename) => fs.existsSync(filename)
  ? undefined
  : `${filename} does not exist`;

let { destination, file, overwrite } = nomnom
  .script('convert-anthems-audio')
  .option('destination', { required: true, callback: exists, help: 'The destination folder, where all converted mp3 will be saved in.' })
  .option('file', { required: true, callback: exists, help: 'The data file with all country information.' })
  .option('overwrite', { flag: true, help: 'Determines if existing mp3 files will be overwritten.' })
  .parse();

const data = JSON.parse(fs.readFileSync(file));

for (let country of data) {
  if (country.anthem) {
    const output = `${destination}/${country.iso3}.mp3`;
    if (overwrite || !fs.existsSync(output)) {
      const maxLengthInSeconds = 88;
      const proc = spawn('ffmpeg', ['-i', country.anthem, '-t', maxLengthInSeconds, '-ac', 2, '-codec:a', 'libmp3lame', '-b:a', '48k', '-ar', '16000', '-y', output]);
      proc.on('close', (code) => {
        if (code === 0) {
          console.info(`Anthem for country "${country.name}" successfully converted.`);
        } else {
          console.error(`Failed to convert anthem for country "${country.name}".`);
        }
      });
    } else {
      console.log(`Anthem for country "${country.name}" already exists.`);
    }
  } else {
    console.info(`No anthem found for country "${country.name}"`);
  }
}
